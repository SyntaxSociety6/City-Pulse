<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityPulse - Interactive Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --accent: #f43f5e;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark-bg: rgba(15, 23, 42, 0.95);
            --dark-card: rgba(30, 41, 59, 0.9);
            --dark-border: rgba(51, 65, 85, 0.6);
            --dark-text: #f1f5f9;
            --dark-muted: #94a3b8;
        }

        body {
            background: var(--dark-bg);
            color: var(--dark-text);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 350px;
            background: var(--dark-card);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .logo {
            padding: 1.5rem;
            border-bottom: 1px solid var(--dark-border);
            text-align: center;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .logo p {
            color: var(--dark-muted);
            font-size: 0.9rem;
        }

        .nav-links {
            padding: 1rem;
            list-style: none;
        }

        .nav-links li {
            margin-bottom: 0.5rem;
        }

        .nav-links a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--dark-text);
            text-decoration: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.2));
        }

        .nav-links i {
            width: 20px;
            text-align: center;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Report Panel */
        .report-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 320px;
            background: var(--dark-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--dark-border);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .report-panel h3 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-muted);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--dark-border);
            border-radius: 0.5rem;
            background: rgba(30, 41, 59, 0.8);
            color: var(--dark-text);
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .coordinates {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .coordinates i {
            margin-right: 0.5rem;
        }

        /* Stats Panel */
        .stats-panel {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: var(--dark-card);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--dark-border);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .stats-panel h4 {
            margin-bottom: 0.75rem;
            color: var(--primary);
            font-size: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 0.5rem;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--dark-muted);
            margin-top: 0.25rem;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 0.5rem;
            color: var(--dark-text);
            cursor: pointer;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Success/Error Messages */
        .message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            background: var(--success);
        }

        .message.error {
            background: var(--danger);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .report-panel {
                width: calc(100% - 2rem);
                right: 1rem;
                left: 1rem;
            }

            .stats-panel {
                left: 1rem;
                right: 1rem;
                width: calc(100% - 2rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>CITY PULSE</h1>
                <p>Urban Growth & Infrastructure Tracker</p>
            </div>
            
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-arrow-left"></i> Back to Dashboard</a></li>
                <li><a href="Main.html"><i class="fas fa-home"></i> Homepage</a></li>
                <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="Infrastructure.html"><i class="fas fa-road"></i> Infrastructure</a></li>
                <li><a href="Real Estate.html"><i class="fas fa-home"></i> Real Estate</a></li>
            </ul>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Report Panel -->
            <div class="report-panel">
                <h3><i class="fas fa-flag"></i> Report an Issue</h3>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="issueType">Issue Type</label>
                        <select id="issueType" required>
                            <option value="">Select Issue Type</option>
                            <option value="road_closure">Road Closure</option>
                            <option value="pothole">Pothole</option>
                            <option value="traffic_light">Traffic Light Issue</option>
                            <option value="streetlight">Street Light Out</option>
                            <option value="garbage">Garbage/Dumping</option>
                            <option value="water_leak">Water Leak</option>
                            <option value="sewage">Sewage Issue</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Describe the issue in detail..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact">Contact (Optional)</label>
                        <input type="text" id="contact" placeholder="Your phone or email">
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                </form>
                
                <div class="coordinates" id="coordinates">
                    <i class="fas fa-map-marker-alt"></i>
                    Click on the map to select location
                </div>
            </div>
            
            <!-- Stats Panel -->
            <div class="stats-panel">
                <h4><i class="fas fa-chart-bar"></i> Live Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="projectsCount">0</div>
                        <div class="stat-label">PROJECTS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="alertsCount">0</div>
                        <div class="stat-label">ALERTS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="reportsCount">0</div>
                        <div class="stat-label">REPORTS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="congestionCount">0</div>
                        <div class="stat-label">CONGESTION</div>
                    </div>
                </div>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" id="locateBtn" title="My Location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="control-btn" id="resetBtn" title="Reset View">
                    <i class="fas fa-home"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([28.6139, 77.2090], 12);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Store selected location
        let selectedLocation = null;
        let selectedMarker = null;

        // API base URL
        const API_BASE = 'http://localhost:4000';

        // Initialize statistics
        let stats = {
            projects: 0,
            alerts: 0,
            reports: 0,
            congestion: 0
        };

        // Load initial data
        loadStats();
        loadExistingReports();

        // Map click handler
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Remove previous marker
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }
            
            // Add new marker
            selectedMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'selected-location',
                    html: '<div style="background-color: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            selectedLocation = { lat, lng };
            
            // Update coordinates display
            document.getElementById('coordinates').innerHTML = 
                `<i class="fas fa-map-marker-alt"></i> Selected: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        });

        // Form submission
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedLocation) {
                showMessage('Please click on the map to select a location first.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const formData = {
                    kind: document.getElementById('issueType').value,
                    description: document.getElementById('description').value,
                    contact: document.getElementById('contact').value,
                    location: selectedLocation,
                    reporterId: 'citizen_' + Date.now()
                };
                
                const response = await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const report = await response.json();
                    showMessage('Report submitted successfully!', 'success');
                    
                    // Add report marker to map
                    addReportMarker(report);
                    
                    // Reset form
                    document.getElementById('reportForm').reset();
                    document.getElementById('coordinates').innerHTML = 
                        '<i class="fas fa-map-marker-alt"></i> Click on the map to select location';
                    
                    // Remove selected marker
                    if (selectedMarker) {
                        map.removeLayer(selectedMarker);
                        selectedMarker = null;
                        selectedLocation = null;
                    }
                    
                    // Update stats
                    stats.reports++;
                    updateStatsDisplay();
                    
                } else {
                    const error = await response.json();
                    showMessage(`Error: ${error.error || 'Failed to submit report'}`, 'error');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showMessage('Network error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Report';
            }
        });

        // Control buttons
        document.getElementById('locateBtn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    
                    // Add user location marker
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location',
                            html: '<div style="background-color: #06b6d4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(map).bindPopup('Your Location');
                });
            } else {
                showMessage('Geolocation is not supported by this browser.', 'error');
            }
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            map.setView([28.6139, 77.2090], 12);
        });

        // Functions
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/state`);
                if (response.ok) {
                    const data = await response.json();
                    stats = {
                        projects: data.projects.length,
                        alerts: data.alerts.length,
                        reports: data.reports.length,
                        congestion: data.congestion.length
                    };
                    updateStatsDisplay();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadExistingReports() {
            try {
                const response = await fetch(`${API_BASE}/reports`);
                if (response.ok) {
                    const reports = await response.json();
                    reports.forEach(report => {
                        addReportMarker(report);
                    });
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function addReportMarker(report) {
            const marker = L.marker([report.location.lat, report.location.lng], {
                icon: L.divIcon({
                    className: 'report-marker',
                    html: `<div style="background-color: #f59e0b; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #f59e0b;">${report.kind.replace('_', ' ').toUpperCase()}</h4>
                    <p style="margin: 0 0 0.5rem 0;">${report.description}</p>
                    <small style="color: #666;">Reported: ${new Date(report.createdAt).toLocaleDateString()}</small>
                </div>
            `);
        }

        function updateStatsDisplay() {
            document.getElementById('projectsCount').textContent = stats.projects;
            document.getElementById('alertsCount').textContent = stats.alerts;
            document.getElementById('reportsCount').textContent = stats.reports;
            document.getElementById('congestionCount').textContent = stats.congestion;
        }

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            messageContainer.appendChild(messageElement);
            
            // Show message
            setTimeout(() => messageElement.classList.add('show'), 100);
            
            // Hide and remove message
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => messageElement.remove(), 300);
            }, 3000);
        }

        // Real-time updates via SSE
        const eventSource = new EventSource(`${API_BASE}/events`);
        
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('SSE Event:', data);
        };
        
        eventSource.addEventListener('report.created', function(event) {
            const report = JSON.parse(event.data);
            addReportMarker(report);
            stats.reports++;
            updateStatsDisplay();
        });
        
        eventSource.addEventListener('project.created', function(event) {
            stats.projects++;
            updateStatsDisplay();
        });
        
        eventSource.addEventListener('alert.created', function(event) {
            stats.alerts++;
            updateStatsDisplay();
        });
        
        eventSource.addEventListener('congestion.created', function(event) {
            stats.congestion++;
            updateStatsDisplay();
        });
    </script>

    <!-- Footer Start -->
    <style>
        footer { background-color: #15202B; color: #AAB8C2; padding: 40px 20px; margin-top: auto; }
        .footer-container { max-width: 1200px; margin: 0 auto; }
        .social-links { display: flex; justify-content: center; align-items: center; padding: 20px 0; border-bottom: 1px solid #38444D; flex-wrap: wrap; }
        .social-links a { color: #AAB8C2; margin: 0 15px; font-size: 1.2rem; transition: color 0.3s; text-decoration: none; }
        .social-links a:hover { color: #ffffff; }
        .logo-section { text-align: center; padding: 30px 0; }
        .footer-nav { display: flex; justify-content: center; flex-wrap: wrap; padding: 20px 0; font-size: 0.9rem; }
        .footer-nav a { color: #AAB8C2; text-decoration: none; margin: 0 10px; transition: color 0.3s; }
        .footer-nav a:hover { color: #ffffff; text-decoration: underline; }
        .footer-nav span { color: #38444D; }
        .chat-button { position: fixed; bottom: 20px; right: 20px; background-color: #15202B; border: 1px solid #38444D; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; transition: transform 0.3s; z-index: 100; }
        .chat-button:hover { transform: scale(1.05); }
        @media (max-width: 768px) {
            .footer-nav { flex-direction: column; align-items: center; gap: 10px; }
            .footer-nav span { display: none; }
            .social-links a { margin: 10px; }
        }
    </style>
    <footer>
        <div class="footer-container">
            <div class="social-links">
                <a aria-label="Facebook" href="#"><i class="fab fa-facebook-f"></i></a>
                <a aria-label="Instagram" href="#"><i class="fab fa-instagram"></i></a>
                <a aria-label="YouTube" href="#"><i class="fab fa-youtube"></i></a>
                <a aria-label="X" href="#"><i class="fab fa-x-twitter"></i></a>
                <a aria-label="LinkedIn" href="#"><i class="fab fa-linkedin-in"></i></a>
                <a aria-label="Medium" href="#"><i class="fab fa-medium-m"></i></a>
                <a aria-label="TikTok" href="#"><i class="fab fa-tiktok"></i></a>
            </div>
            <div class="logo-section">
                <p>Copyright ©️ 2025 CityPulse, Inc.</p>
            </div>
            <nav class="footer-nav">
                <a href="#">Legal Stuff</a>
                <span>|</span>
                <a href="#">Privacy Policy</a>
                <span>|</span>
                <a href="#">Security</a>
                <span>|</span>
                <a href="#">Website Accessibility</a>
                <span>|</span>
                <a href="#">Manage Cookies</a>
                <span>|</span>
                <a href="#">Your Privacy Choices</a>
            </nav>
        </div>
    </footer>
    <div class="chat-button">
        <i class="fas fa-comment" style="color: #AAB8C2; font-size: 24px;"></i>
    </div>
    <!-- Footer End -->

</body>
</html>
